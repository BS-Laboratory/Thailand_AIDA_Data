---
title: "Data management for AIDA data"
author: "Kemmapon Chumchuen"
date: "2020-05-25"
output: html_document
---


## Load packages and dataset

- ข้อมูลตัวอย่างโหลดมาจาก [Google Form AIDA CRF](https://docs.google.com/forms/u/2/d/1p0AwxOOflxAQL8AvVncuBvGUMocvGtxQNRcl5_zJpAY/edit?usp=docs_home&ths=true)
```{r, message=F}
library(epicalc) 
library(readxl) 
library(plyr) 
library(splitstackshape)
library(BSL)


Sys.setlocale("LC_CTYPE", "thai")
options(encoding="UTF-8")
imp.template <- read.csv("ThailandAIDAData_ImportTemplate_2021-04-07.csv", header = T)
scr.dat <- read_excel("Siriraj-AIDA Screening (Sample Responses).xlsx", skip = 0, sheet = 1)
scs.dat <- read_excel("SCS datasheet3.xlsx", skip = 0, sheet = 1)

```

## Cleaning screening data

### Renaming variables of screening dataset

```{r}
str(scr.dat)
colnames(scr.dat)
imp.col.scr1 <- colnames(imp.template[2:23])
```
Replace the column names from google form data with ones from data import tool

```{r}
names(scr.dat) <- imp.col.scr1
colnames(scr.dat)
```

### Revalue the level of variables from screening dataset

```{r}
yn <- c("ใช่","ไม่ใช่")
hv <- c("เคย","ไม่เคย")

scr.dat[,2:22] <- as.data.frame(sapply(scr.dat[,2:22],
                                       mapvalues, from = yn, to = c(1,0)))
scr.dat[,2:22] <- as.data.frame(sapply(scr.dat[,2:22],
                                       mapvalues, from = hv, to = c(1,0)))
```

Check the modified values
```{r}
scr.dat[,1:3]
scr.dat[,6:12]
```
```{r}
scr.dat[,12:15] <- as.data.frame(ifelse(scr.dat[,12:15]=="ไม่ได้รับประทาน",0,1))
```

Check the modified value

```{r}
scr.dat[,11:15]
```

Deal with the "ไม่มี" in these 2 variables. Final format will depend on the decision made in the next meeting

```{r}
scr.dat[,16:17] <- as.data.frame(sapply(scr.dat[,16:17],
                                     mapvalues, from = "ไม่มี", to = NA))
scr.dat[,12:17]
```

Modified sex value
```{r}
scr.dat$sex_sc <- ifelse(scr.dat$sex_sc=="ชาย",1,2) 
colnames(scr.dat)
```

Screening Data is cleaned.

Back up data in rds format

```{r}
saveRDS(scr.dat,"cleaned scr.rds")
scr.dat <- readRDS("cleaned scr.rds")
```

Screening data is ready to import to REDCap template.


## Cleaning single cell sequencing data

### Renaming variables of sequencing data

```{r}
str(scs.dat)
colnames(scs.dat[1:21])
colnames(imp.template[25:53])
```
Replace the column names from google form data with ones from data import tool.

```{r}
imp.col.scr2 <- colnames(imp.template[25:53])

colnames(scs.dat)[1:29]  <- imp.col.scr2
colnames(scs.dat)
```

Generate columns for dx_disease to match REDCap template.

Changing variable name for checkbox_ functions.
```{r}
names(scs.dat)[30] <- "dxnosis"
colnames(scs.dat)
```

Generating columns based on the level obtained using BSL package

Preview and check the order
```{r}
preview <- checkbox_preview(data = scs.dat, var = dxnosis)
preview
colnames(preview) 
```
The order is 3,2,4,5,0,8,6,7

Assign the names based on order
```{r}
dx.redcap <- checkbox_assign(preview,prefix = "dx_disease__",suffix = c(3,2,4,5,0,8,6,7))
dx.redcap
des(dx.redcap)
```


Delete the google format column 
```{r}
scs.dat <- scs.dat[,-30]
```

Changing the rest of column names
```{r}
imp.col.scr3 <- colnames(imp.template[72:78])
colnames(scs.dat)[30:36]  <- imp.col.scr3
colnames(scs.dat)
```

Generate columns for taking_hormones to match REDCap template using BSL package

Changing the variable name for checkbox_ functions.

```{r}
names(scs.dat)[37] <- "drug.horm"
colnames(scs.dat)
```


Generating columns based on the level obtained and its order

```{r}
preview2 <- checkbox_preview(scs.dat,var = drug.horm) 
colnames(preview2)
```

The order is 3,1,0,9,10,x,5,8,6,11,y,7,4,2
There're 2 "other" value, assign it to 12 and 13 (last value is 11)
12 is ยาผีบอก, and 13 is ยาลูกกลอน

```{r}
drug.redcap <- checkbox_assign(preview2,prefix = "taking_hormones__", suffix = c(3,1,0,
                              9,10,12,5,8,6,11,13,7,4,2))
drug.redcap
```

```{r}
drug.redcap <- checkbox_oth(drug.redcap, other = c(5,6), 
                            other.names = c("ยาผีบอก","ยาลูกกลอน"),
                            new.col = "taking_hormones__oth")
drug.redcap
des(drug.redcap)
```

Delete the google format column and merged the new columns, **always check the colum number**

```{r}
scs.dat <- scs.dat[,-37]
```

Add 3 sets of newly generated columns

```{r}
scs.dat <- cbind(scs.dat[1:29],dx.redcap,scs.dat[30:36],drug.redcap,scs.dat[37:38])
des(scs.dat)

```

Checking
```{r}
scs.dat[,50:59]
```

Change the last variable name, **always check for the last column**, as it can be varied due to added levels
```{r}
names(scs.dat)[58] <- "taking_hormone_period"
names(scs.dat)[59] <- "taking_vaccine"
des(scs.dat)
```

### Revalue the levels of variables from sequencing dataset
**Always consider the number of columns when revalue, as it can change in every entry**


```{r}
scs.dat$sex <- ifelse(scs.dat$sex=="ชาย",1,2)

hl <- c("รู้สึกอ่อนเพลีย/เหนื่อย ขณะนั่งพัก","ไม่มีอาการใดๆขณะพัก แต่เหนื่อยง่ายสำหรับกิจกรรมเล็กๆน้อยๆในบ้าน",
        "ไม่มีอาการขณะพัก แต่อาจเหนื่อยหอบถ้าต้องเดินขึ้นบรรได เดินซื้ออาหาร","เดินขึ้นบันไดหรือวิ่งระยะสั้นได้")    

scs.dat$health_level <- mapvalues(scs.dat$health_level,from = hl, to = c(1,2,3,4))

scs.dat$health_level

des(scs.dat)

yn <- c("ใช่","ไม่ใช่")
hv <- c("เคย","ไม่เคย")

scs.dat[,9:59] <- as.data.frame(sapply(scs.dat[,9:59],
                                mapvalues, from = yn, to = c(1,0)))
scs.dat[,9:59] <- as.data.frame(sapply(scs.dat[,9:59],
                                       mapvalues, from = hv, to = c(1,0)))

sm <- c("ไม่เคยสูบ","หยุดสูบแล้ว","สูบอยู่")

scs.dat$smoking <- mapvalues(scs.dat$smoking,from = sm, to = c(0,1,2))

alc <- c("ไม่เคยดื่มเลย","เลิกดื่มแล้ว",
         "น้อยกว่าเดือนละครั้ง (เช่น 2-3 เดือนครั้ง หรือ นานกว่านั้นต่อครั้ง)","ประมาณเดือนละครั้ง","ดื่มเกือบทุกสัปดาห์","ดื่มมากกว่า 1 ครั้งต่อสัปดาห์")

scs.dat$alcohol <- mapvalues(scs.dat$alcohol, from = alc, to = c(1,2,3,4,5,6))

head(scs.dat)
```

Single Cell Sequence Data is cleaned

SaveRDS as a back up

```{r}
saveRDS(scs.dat,"cleaned scs.rds")
scr.dat <- readRDS("cleaned scr.rds")
```

This file is ready to import to REDCap template

## Merging cleaned data to REDCap template and export
```{r}
dat.ready.imp <- as.data.frame(cbind(scr.dat,scs.dat))

imp.dat <- rbind.fill(imp.template,dat.ready.imp)
des(imp.dat)
```

In case of data entry via google form, don't forget to add record_id in R and delete the last extra column 

```{r}
imp.dat$record_id <- c(1:5)
imp.dat <- imp.dat[,-96]

```

Manage date and time variable, as class could be altered during merging 

```{r}
imp.dat$timestamp <- scs.dat$timestamp
imp.dat$timestamp_sc <- scr.dat$timestamp_sc
imp.dat$date_recording <- scs.dat$date_recording
```


Export in CSV format and upload this file to REDCap
```{r}
write.csv(imp.dat,file = "Data Formated for REDCap Importation.csv", fileEncoding = "UTF-8",
          na="", row.names = F)
```
